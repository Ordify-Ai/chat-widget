name: Publish to NPM and Mirror to GitHub Packages

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (dry-run)'
        required: false
        default: 'false'
        type: boolean
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write  # Required for Trusted Publishing (OIDC)
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Prepare package for NPM publishing
      run: |
        # Change package name for NPM (unscoped) BEFORE setup-node
        # This ensures Trusted Publishing can verify the package correctly
        npm pkg set name="ordify-chat-widget"
        npm pkg delete publishConfig
        # Ensure repository field matches GitHub repo exactly for Trusted Publishing
        # Must match: Ordify-Ai/chat-widget (case-sensitive)
        npm pkg set repository.type="git"
        npm pkg set repository.url="git+https://github.com/Ordify-Ai/chat-widget.git"
        echo "Package name set to: $(node -p "require('./package.json').name")"
        echo "Repository set to: $(node -p "require('./package.json').repository.url")"
        
    - name: Setup Node.js for NPM
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        # Trusted Publishing uses OIDC - no token needed
        
    - name: Install dependencies
      run: npm ci
        
    - name: Build package
      run: npm run build
        
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Auto-bump version if needed
      id: version-bump
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # Check if version exists, if yes, bump patch version
        if npm view ordify-chat-widget@$CURRENT_VERSION version >/dev/null 2>&1; then
          echo "Version $CURRENT_VERSION already exists on NPM, bumping patch version..."
          npm version patch --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "Bumped to version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          
          # Commit version bump
          git add package.json
          git commit -m "chore: auto-bump version to $NEW_VERSION [skip ci]" || exit 0
          git push || echo "Push failed, continuing..."
        else
          echo "Version $CURRENT_VERSION is new on NPM, using it"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "bumped=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Verify Trusted Publishing configuration
      run: |
        echo "=== Package Configuration ==="
        PKG_NAME=$(node -p "require('./package.json').name")
        PKG_VERSION=$(node -p "require('./package.json').version")
        PKG_REPO=$(node -p "require('./package.json').repository.url")
        echo "Name: $PKG_NAME"
        echo "Version: $PKG_VERSION"
        echo "Repository: $PKG_REPO"
        echo ""
        echo "=== GitHub Context ==="
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Workflow file: ${{ github.workflow_ref }}"
        echo ""
        echo "=== Trusted Publishing Verification ==="
        echo "Checking if package exists on npm..."
        if npm view "$PKG_NAME" version >/dev/null 2>&1; then
          echo "✅ Package $PKG_NAME exists on npm"
          LATEST_VERSION=$(npm view "$PKG_NAME" version)
          echo "Latest version on npm: $LATEST_VERSION"
        else
          echo "❌ Package $PKG_NAME does NOT exist on npm"
          echo "This might be the first publish, or package name is incorrect"
        fi
        echo ""
        echo "=== Trusted Publisher Requirements ==="
        echo "On npm, Trusted Publisher must be configured with:"
        echo "  - Repository: Ordify-Ai/chat-widget (exact case)"
        echo "  - Workflow file: publish.yml"
        echo "  - Package repository URL must match: $PKG_REPO"
        echo ""
        echo "Current package.json repository: $PKG_REPO"
        echo "Expected: git+https://github.com/Ordify-Ai/chat-widget.git"
        if [ "$PKG_REPO" = "git+https://github.com/Ordify-Ai/chat-widget.git" ]; then
          echo "✅ Repository URL matches"
        else
          echo "❌ Repository URL MISMATCH - This will cause 404 error!"
          exit 1
        fi
        
    - name: Test npm authentication (dry-run)
      run: |
        echo "=== Testing npm authentication ==="
        echo "Running npm whoami to check authentication..."
        npm whoami || echo "Not authenticated (expected for Trusted Publishing)"
        echo ""
        echo "Attempting dry-run publish to verify Trusted Publishing..."
        npm publish --dry-run --access public --provenance || echo "Dry-run completed"
        
    - name: Publish to NPM
      if: github.event_name != 'pull_request' && (github.event.inputs.test_mode != 'true')
      run: |
        # Using Trusted Publishing (OIDC) - no token needed
        # --provenance flag generates cryptographic proof of build origin
        # Repository URL must match Trusted Publisher configuration exactly
        echo "Publishing $PKG_NAME@$PKG_VERSION to npm..."
        npm publish --access public --provenance
        
    - name: Dry-run publish (test mode)
      if: github.event_name == 'pull_request' || github.event.inputs.test_mode == 'true'
      run: |
        echo "=== DRY RUN MODE ==="
        echo "Would publish: ordify-chat-widget@$(node -p "require('./package.json').version")"
        echo "Repository: $(node -p "require('./package.json').repository.url")"
        echo "Skipping actual publish in test/dry-run mode"
        npm pack --dry-run

  mirror-to-github:
    needs: publish-npm
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@ordify-ai'
        
    - name: Restore package.json for GitHub Packages
      run: |
        # Get the version that was published to NPM (may have been auto-bumped)
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Restoring package.json for GitHub Packages with version: $CURRENT_VERSION"
        
        # Restore scoped name and publishConfig for GitHub Packages
        npm pkg set name="@ordify-ai/chat-widget"
        npm pkg set publishConfig.registry="https://npm.pkg.github.com"
        echo "Package name set to: $(node -p "require('./package.json').name")"
        echo "Publish config: $(node -p "JSON.stringify(require('./package.json').publishConfig)")"
        
        # Explicitly configure npm registry for GitHub Packages
        echo "@ordify-ai:registry=https://npm.pkg.github.com" >> .npmrc
        echo "Registry configured for @ordify-ai scope"
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build package
      run: npm run build
      
    - name: Mirror to GitHub Packages
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Mirroring version $CURRENT_VERSION to GitHub Packages"
        
        # Check if version already exists, skip if it does
        if npm view @ordify-ai/chat-widget@$CURRENT_VERSION version >/dev/null 2>&1; then
          echo "Version $CURRENT_VERSION already exists on GitHub Packages, skipping..."
        else
          echo "Publishing version $CURRENT_VERSION to GitHub Packages"
          npm publish
        fi
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}