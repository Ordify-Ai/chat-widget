name: Test Publish Configuration (No Actual Publish)

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  push:
    branches-ignore:
      - main
      - 'release/**'
    # Runs on any branch except main and release branches

jobs:
  test-publish-config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC (even for testing)
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Prepare package for NPM publishing
      run: |
        # Change package name for NPM (unscoped) BEFORE setup-node
        npm pkg set name="ordify-chat-widget"
        npm pkg delete publishConfig
        # Ensure repository field matches GitHub repo exactly for Trusted Publishing
        npm pkg set repository.type="git"
        npm pkg set repository.url="git+https://github.com/Ordify-Ai/chat-widget.git"
        echo "Package name set to: $(node -p "require('./package.json').name")"
        echo "Repository set to: $(node -p "require('./package.json').repository.url")"
        
    - name: Setup Node.js for NPM
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build package
      run: npm run build
      
    - name: Verify Trusted Publishing configuration
      run: |
        echo "=== Package Configuration ==="
        PKG_NAME=$(node -p "require('./package.json').name")
        PKG_VERSION=$(node -p "require('./package.json').version")
        PKG_REPO=$(node -p "require('./package.json').repository.url")
        echo "Name: $PKG_NAME"
        echo "Version: $PKG_VERSION"
        echo "Repository: $PKG_REPO"
        echo ""
        echo "=== GitHub Context ==="
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo ""
        echo "=== Trusted Publishing Verification ==="
        echo "Checking if package exists on npm..."
        if npm view "$PKG_NAME" version >/dev/null 2>&1; then
          echo "✅ Package $PKG_NAME exists on npm"
          LATEST_VERSION=$(npm view "$PKG_NAME" version)
          echo "Latest version on npm: $LATEST_VERSION"
        else
          echo "⚠️  Package $PKG_NAME does NOT exist on npm (might be first publish)"
        fi
        echo ""
        echo "=== Trusted Publisher Requirements ==="
        EXPECTED_REPO="git+https://github.com/Ordify-Ai/chat-widget.git"
        echo "Expected repository URL: $EXPECTED_REPO"
        echo "Actual repository URL: $PKG_REPO"
        if [ "$PKG_REPO" = "$EXPECTED_REPO" ]; then
          echo "✅ Repository URL matches"
        else
          echo "❌ Repository URL MISMATCH!"
          echo "This will cause 404 error during publish"
          exit 1
        fi
        echo ""
        echo "=== What to check on npm ==="
        echo "Go to: https://www.npmjs.com/package/$PKG_NAME/settings"
        echo "Verify Trusted Publisher shows:"
        echo "  - Repository: Ordify-Ai/chat-widget"
        echo "  - Workflow file: publish.yml"
        echo ""
        echo "The repository URL in package.json must match what npm expects"
        
    - name: Test npm pack (dry-run)
      run: |
        echo "=== Testing package creation ==="
        npm pack --dry-run
        echo "✅ Package can be created successfully"
        
    - name: Test actual publish attempt (will fail gracefully)
      run: |
        echo "=== Testing Actual Publish (This will fail but show the real error) ==="
        echo "Attempting to publish to see the actual error from npm..."
        echo "This is safe - we're on a dev branch, so even if it succeeds, it won't affect main"
        echo ""
        PKG_NAME=$(node -p "require('./package.json').name")
        PKG_VERSION=$(node -p "require('./package.json').version")
        
        # Try to publish - this will show the real error
        # We'll catch the error so the workflow doesn't fail completely
        set +e  # Don't exit on error
        npm publish --access public --provenance 2>&1 | tee publish-attempt.log
        PUBLISH_EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        echo ""
        echo "=== Publish Attempt Result ==="
        if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
          echo "✅ Publish succeeded! (unexpected on dev branch)"
        else
          echo "❌ Publish failed (expected - this shows us the real error)"
          echo ""
          echo "=== Error Details ==="
          cat publish-attempt.log | grep -A 10 "npm error" || cat publish-attempt.log
          echo ""
          echo "=== Common Issues ==="
          echo "If you see 404 'not in this registry':"
          echo "  1. Check Trusted Publisher on npm matches exactly:"
          echo "     - Repository: Ordify-Ai/chat-widget"
          echo "     - Workflow file: publish.yml (not test-publish.yml)"
          echo "  2. The repository URL in package.json must match what's in Trusted Publisher"
          echo "  3. Make sure you're publishing from the 'main' branch (Trusted Publishing requirement)"
        fi
